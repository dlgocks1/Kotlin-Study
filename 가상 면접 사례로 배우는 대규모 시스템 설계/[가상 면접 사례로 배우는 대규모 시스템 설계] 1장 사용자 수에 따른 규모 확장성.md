몇 백만 사용자를 지원하는 서비스를 만들기위한 지식들에 대해 알아본다.

## 단일 서버

기존에는 한 대의 서버에서 모든 컴포넌트가 실행되었다. 이때는 웹 앱, 데이터베이스, 캐시 등이 전부 한 대의 서버에서 실행되었다.

사용자의 요청이 처리되는 과정은 다음과 같다.

1. 사용자가 도메인을 이용하여 웹사이트에 접속 시도
2. 접속을 위해서 DNS에 질의하는 과정을 거침
3. IP주소를 활용해 우리가 뛰운 단일 서버로 접속
4. HTTP요청이 해당 서버로 전송됨
5. 서버는 HTML페이지나 JSON형태의 응답 반환

실제 요청은 어디로 부터 오는가?

- 웹 어플리케이션 : 비즈니스 로직, 데이터 저장 등을 처리하기 위해서는 서버구현용 언어(자바, 파이썬)을 활용, 프레텐테이션을 위해서는 클라이언트용 언어(HTML, JS)등을 활용
- 모바일 앱 : HTTP프로토콜을 활용

## 데이터베이스

사용자가 증가함에 따라 트래픽을 처리하는 용도 이외에도 데이터베이스를 추가해야한다.

- 웹/모바일 트래픽 처리 서버(웹 계층)
- 데이터베이스 서버(데이터 계층)

으로 분리하여 각각을 독립적으로 확장이 가능하다.

---

데이터 베이스는 크게 두가지로 나뉜다.

- 관계형 데이터 베이스
- 비-관계형 데이터 베이스
   - 키-밸류 저장소
   - 그래프 저장소
   - 칼럼 저장소
   - 문서 저장소
   
비 관계형 데이터베이스는 다음과 같은 상황에서 유용하게 쓰인다.

- 아주 낮은 레이턴시 요구
- 다루는 데이터의 형식이 정해져 있지 않을 떄
- 데이터를 직렬화하거나, 역직렬화하기만 하면 될 때
- 데이터량이 많을 때


### 수직적 확장 vs 수평적 확장

- 수직적 확장 : CPU, 램 추가
  - 장점 : 단순하다.
  - 단점 : CPU, 메모리의 무한 증설 불가, 자동 복구나 다중화 방안 X
- 수평적 확장 : 서버 더 추가
  - 장점 : 싸다.
  - 단점 : 자동 복구나 다중화 방안 마련이 복잡하다.
  
대규모 웹 어플리케이션에서는 수평적 확장이 적절하다.


### 로드 밸런서

부하 분삽 집합이라고 불리기도 하며 요청을 고르게 분산시킨다.

> 주로 라운드 로빈 알고리즘을 활용한다.


### 데이터베이스 다중화

서버는 응답속도가 늦으면 늘리면되는데 데이터베이스는 그러기 애매하다. 그래서 데이터베이스의 다중화는 약간 특별하다.

> 이는 읽기와 쓰기가 분산되는 상황을 고려하기 위해서인데 주로 `master-slave`구조로 구성되며 읽기는 `slave`에서, 쓰기는 `master`에서 실시하여 부하를 분산하는 구조이다. (`slave`는 마스터를 복제)


![](https://velog.velcdn.com/images/cksgodl/post/ca5e8ea2-47e2-4a87-bab3-9d780064bf4e/image.png)

특징으로써는

- 더 나은 성능 : 데이터 변경 연산은 주 데이터베이스 서버로만 전달됨으로 병렬 쿼리가 가능
- 안정성 및 가용성 : 노예 한 개가 터져도 잘 작동 함

---

위와 같은 구조를 모두 사용하여 안정성과 성능을 모두 개선할 수 있다. 하지만 응답시간을 개선하기 위해서는 `캐쉬`와 `CDN`을 이용할 수 있다.


### 캐시

> 비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고 빨리 처리할 수 있도록 한다. (메모리는 접근 속도가 빠름)

캐시 계층은 물리계층보다 훨씬 빠르다. 그리고 이런 특징을 이용해 내부 메모리 캐시뿐만 아니라 따로 캐시 서버를 구축하기도 한다.

```
웹 서버 <-> 캐시 서버 <-> DB
```

#### 캐시 사용시 유의 점

- 갱신이 적고, 참조가 빈번할 때 사용
- 휘발성 메모리임을 유의
- 캐시 만료 시간에 대하여 생각
- 일관성 유지에 대하여 고려
- 장애 복구 프로세스에 대해 생각
- 적절한 캐시의 크기와 캐시 이빅션
- 데이터 방출 정책(LRU, LFU, FIFO 등)


### CDN 

정적 콘텐츠를 전송하는 데 쓰이는 분산 서버 네트워크를 의미한다. (이미지, 비디오, CSS, JavaScript 파일 등)

> 간단하게 요약하자면, `request path`, `query string`, `cokkie`, `request header`에 기반하여 `HTML`페이지를 캐싱하는 것 이 CDN 캐싱이다.

`html` 페이지 내용뿐만 아니라, 이미지, 비디오 등 갱신이 적고, 참조가 빈번한 정적 콘텐츠들을 내부에서 캐싱한다.


- 이는 보통 제3 사업자에 의해 운영되며, 비용고려 필요
- 적절한 만료 시한 설정
- CDN이 죽었을 때 대안 생각 (클라이언트에서 원본 서버 직접 접속)
- 콘텐츠 무효화 방안 생각
   - CDN API 사용
   - 오브젝트 버저닝 사용
   
![](https://velog.velcdn.com/images/cksgodl/post/4a16e6ec-d41d-4cca-8376-2a8f40c4ebe2/image.png)

## 무상태 웹 계층

말은 복잡하지만 서버에서 어떤 상태도 저장하지 않는 상태를 의미한다. (스프링의 서비스계층에서 어떠한 상태도 유지하지 않 듯)

이들은 공유저장소(레포지토리)를 활용하여 상태를 얻어와야 한다.

공유 저장소란 캐시서버, 데이터베이스서버 등 영구적 저장소를 나눠논 것을 의미한다.


## 데이터 센터

지리적 라우팅을 통해 사용자의 위치에 따라 데이터 센터 라우팅이 가능하다.(로드밸런서에 의해 이루어짐)

인터넷 데이터 센터(Internet Data Center)라고 불리기도 하며 내부에 다양한 데이터베이스, 캐시서버, 웹서버 등이 들어있다.


## 메시지 큐

> 메시지 큐는 메시지의 무손실의 특성을 보장하는 비동기 통신을 지원하는 컴포넌트이다.

카프카가 대표적인 예시이며, 메시지 버퍼역할을 수행하기도 하고 비동기적으로 작동한다.

메시지 큐를 활용하면 서비스 간 결합이 느슨해져서 규모 확장성이 보장되는 안정적인 어플리케이션 설계가 가능하다. 

Why? -> 생산자가 죽어도 소비가 가능하며, 소비자가 없어도 생산이 가능하기 떄문

## 로그, 메트릭 그리고 자동화

대규모 어플리케이션에서 로그 및 메트릭의 측정은 필수이다.

- 로그 : 에러로그, 디버그 로그 등
- 메트릭 : 사업 현황에 대한 정보, 시스템의 현재 상태에 대한 메트릭 등
- 자동화 : CI/CD를 통한 배포자동화 등

## 데이터베이스의 규모 확장

앞서 말했듯 규모 확장에는 2가지 방법이있다.

#### 수직적 확장

고성능 자원의 투입을 통한 증설

- SPOF(Single Point Of Failure)으로 인한 위험성
- 비용이 많이 듬
- 무한 증설 붉k

#### 수평적 확장

데이터베이스 샤딩이라고 불리기도 한다. 모든 샤드는 같은 스키마를 쓰지만 샤드에 보관되는 데이터 사이에 중복은 없다.

위와 같은 구조를 구현하기 위해서는 샤딩 키(파티션 키)라는 개념이 도입된다.

> 예를 들면 샤딩 키의 해쉬값을 통해 데이터를 각각 다른 샤드에 저장하는 구조를 생각할 수 있다. ( 골고루 데이터를 분산하는 샤딩 키를 구현하는 것이 중요하다. )


특징으로써는

- 데이터의 재 샤딩 : 데이터가 너무 많아 한 샤드로 감당할 수 없을 때 데이터를 재배치해야한다. (안전 해시기법 활용 가능)
- 유명인사 : 적절한 샤드키 분산 실패로 몰릴 때
- 조인과 비정규화 : 데이터 조인하기 힘들다. 데이터베이스 비정규화 필요

## 백만 사용자, 그리고 그 이상

위에서 설명한 과정을 계속 반복하면 대규모 어플리케이션을 구현할 수 있다. 하지만 사용자가 백만명 이상으로 증가하게 된다면 시스템을 좀 더 최적화하고 더 작은 단위로 분할할 필요가 있다. (MSA의 도입)

이후에 해당 시스템을 논하도록 하고, 대규모 어플리케이션 시스템 확장을 위해 기법을을 다시 정리해보자.

## 요약

- 무상태 계층(서버)유지
- 모든 계층 다중화 도입(서버 계층, 데이터 계층)
- 여러 데이터 센터를 지원할 것
- 정적 콘텐츠는 CDN활용
- 데이터 계층은 샤딩을 통해 규모 확장
- 각 계층은 독립적 서비스로 분할
- 시스템 모니터링 툴 및 CI/CD자동화 도입



